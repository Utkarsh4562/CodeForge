const jwt = require('jsonwebtoken');
const User = require("../models/user");
const redisClient = require("../config/redis");

const userMiddleware = async (req, res, next) => {
    try {
        const token = req.cookies.token;
        if (!token)
            return res.status(401).json({ error: "token is not present" });

        const payload = jwt.verify(token, process.env.JWT_KEY);
        const { _id } = payload;
        
        if (!_id)
            return res.status(401).json({ error: "Id is missing" });

        const result = await User.findById(_id);

        if (!result)
            return res.status(401).json({ error: "user not find" });

        // Try Redis check, but continue if it fails
        try {
            const IsBlocked = await redisClient.exists(`token:${token}`);
            if (IsBlocked)
                return res.status(401).json({ error: "token is blocked" });
        } catch (redisError) {
            // Redis not available, skip check
        }

        req.result = result;
        next();
    } catch(err) {
        if (err.name === 'JsonWebTokenError') {
            return res.status(401).json({ error: "Invalid token" });
        }
        res.status(401).json({ error: err.message });
    }
}

module.exports = userMiddleware;